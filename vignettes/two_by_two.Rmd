---
title: "Two-by-Two Factorial"
output: rmarkdown::html_vignette
bibliography: bib.bib
nocite: | 
  @murray1998design  
vignette: >
  %\VignetteIndexEntry{Two-by-Two Factorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Studying causal mechanisms is hard. One of the best ways we know to study if one cause works better or worse when another one is present is through a two-by-two experiment. As its name suggests, the design involves two overlapping two-arm experiments. 

Before conducting studies of this kind, researchers often want to increase their confidence in their ability to detect significant interactions when the effect of $Z_1$ on $Y$ really is a function of $Z_2$. How many subjects are needed to raise the probability of correctly inferring that there is an interaction 80\%?

This is a surprisingly difficult question to answer, because answering it accurately depends upon the specific model of the potential outcomes the researcher has in mind. As a result, many researchers use rules of thumb that may lead to systematic over- or under-confidence. Using the MIDA framework and design simulation, however, we can provide a flexible answer to this question that does not rely on rules of thumb.

### MIDA

- **M**odel: We specify $Z_1$ and $Z_2$ do not have any effect on the outcome when only one of the causal agents becomes present. When both are present the combination of the causal factors produces an increase of 1/10th of a standard deviation in the outcome.

- **I**nquiry: We can express the effect of $Z_1$ when $Z_2$ is present as $\tau_{Z_1 \mid Z_2} = E[(Y \mid Z_1 = 1, Z_2 = 1) - (Y \mid Z_1 = 0, Z_2 = 1)]$, and the effect of $Z_1$ when $Z_2$ is absent as $\tau_{Z_1 \mid \neg Z_2} = E[(Y \mid Z_1 = 1, Z_2 = 0) - (Y \mid Z_1 = 0, Z_2 = 0)]$. Thus, our estimand is $\tau_{Z_1 \mid Z_2} - \tau_{Z_1 \mid \neg Z_2}$: the difference in the effect of $Z_1$ induced by moving $Z_2$ from 0 to 1.

- **D**ata strategy: We randomly assign an equal number of subjects to one of four conditions. In the first both causal factors are absent, in the second and third only $Z_1$ or $Z_2$ is present, respectively, and in the fourth both are present. 

- **A**nswer strategy: We estimate the interaction effect using a linear regression model that focuses on the coefficient on the $Z_1 \times Z_2$ term.

### Declaration

Our `factorial_template` function takes as arguments the total sample size (`N`), the effect of $Z_1$ (`beta_1`), the effect of $Z_2$ (`beta_2`), and the effect of $Z_1 \times Z_2$ (`beta_3`). 

```{r,echo = TRUE, eval = rerun_templates}
factorial_template <-
  function(N, beta_1 = 0, beta_2 = 0, beta_3) {
    population <- declare_population(noise = rnorm(N), N = N)
    potential_outcomes <-
      declare_potential_outcomes(
        Y_Z_0 = noise,
        Y_Z_1 = beta_1 + noise,
        Y_Z_2 = beta_2 + noise,
        Y_Z_3 = beta_1 + beta_2 + beta_3 + noise
      )
    assignment_factorial <-
      declare_assignment(condition_names = 0:3)

    estimand <-
      declare_estimand(interaction_effect = mean((Y_Z_3 - Y_Z_2) - (Y_Z_1 - Y_Z_0)))

    estimator <- declare_estimator(
      formula = Y ~ Z1 + Z2 + Z1 * Z2,
      model = lm_robust,
      coefficient_name = "Z1:Z2",
      estimand = estimand
    )
    declare_design(
      population,
      potential_outcomes,
      assignment_factorial,
      mutate(Z1 = as.numeric(Z %in% c(1, 3)),
             Z2 = as.numeric(Z %in% c(2, 3))),
      reveal_outcomes,
      estimator,
      estimand
    )
  }
```


### Takeaways

```{r, echo=FALSE}
diagnosand_plot <- diagnoses$diagnosands %>%
  filter(beta_3 == .25) %>% 
  ggplot(aes(N, power)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0.8, color = "red") +
  xlab("Number of Subjects") +
  scale_y_continuous("Power to Detect a 0.25 SD Interaction",breaks = c(seq(0,1,.25),8), limits = c(0,1)) +
  ggtitle("2x2 Factorial Experiment", "Power Analysis") +
  theme_bw()

if (knitr::opts_knit$get("rmarkdown.pandoc.to") != "html") {
  diagnosand_plot
}
```

### Exercises

1. Alter the template so that outcomes are binary instead of normally distibuted. What is the expected standard error for the interaction term for a sample size of 1000? Discuss the implications of your diagnosis for practice.

2. Heterogeneous shifts by making effects noise
