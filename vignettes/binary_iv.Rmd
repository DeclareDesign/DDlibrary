---
title: "Binary Instrumental Variable"
output: rmarkdown::html_vignette
bibliography: bib.bib
nocite:
  
vignette: >
  %\VignetteIndexEntry{Binary Instrumental Variable}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- cite imbens -->
```{r MIDA, echo = FALSE,include = FALSE}
library(DesignLibrary)
library(knitr)
```

The main idea underpinning randomized control trials is that random assignment yields comparable groups that are similar along pre-treatment variables and differ only in the treatment(s) that researchers are interested in studying. Instrumental variables methods are often used in experimental or observational settings where we *cannot* credibly assume the treatment of interest is randomly assigned.

Take two examples of causal relationships researchers might be interested in observing: the effect of distributive benefits on voter turnout and the effect of fertilizer use on farmers' crop yield. In both cases, the distribution of resources or the use of fertilizer may depend on the outcome we wish to study ---on the one hand, politicians may disburse funds according to local electoral characteristics, and on the other, famers with higher crop yield might be both more likely to use fertilizers. Instrumental variables can be a useful approach in these contexts where a treatment $X$ is endogenous to an outcome $Y$.

Strong instrumental variables satisfy four key assumptions:

* *Relevance* assumption: The instrument $Z$ has a causal effect on the treatment $X$.
* *Exclusion restriction*: The instrument $Z$ affects the outcome $Y$ only through the treatment $X$.
* *Exchangeability* (or *independence*) assumption: The instrument $Z$ is as good as randomly assigned (i.e., there is no confounding for the effect of $Z$ on $Y$).
* *Monotonicity* or *no-defiance* assumption: For all units $i$, $X_i(z_1) \geqslant X_i(x_2)$ when $z_1 \geqslant z_2$ (i.e., there are no units that always defy their assignment).

Using the examples above, researchers could choose to instrument distributive benefits with a naturally occurring disaster ---the occurence of a hurricane is correlated with the disbursement of relief aid by the government but may be independent of voter turnout. Similarly, researchers might randomly assign some farmers fertilizer vouchers as an instrument for fertilizer use. 

Intention to treat
First stage
Second stage

The `binary_iv_designer()` function allows researchers to declare a design of a single instrument $Z$ to estimate the effect of an endogenous treatment $X$ on an outcome $Y$, all of which are binary variables. Below we declare a design using the fertilizer example.

## Design Declaration

  <!-- - **M**odel: We assume there are four compliance types in a sample of $N$ farmers: always-takers, never-takers, compliers, and defiers ($types = {a,n,c,d}$) such that X() -->

  - **M**odel: We assume our sample has three out of four possible compliance types in a sample of $N$ farmers: always-takers, never takers, and compliers. In order for the monotonicy assumption to hold, we assume there are no defiers in our sample (no farmers who will adopt fertilizer use if not given the voucher, and who will not adopt it if given the voucher). Below is how we define $X(Z)$ with $Z \in {0,1}$ for each type:
  
  | Type       | $X_i(0)$ | $X_i(1)$ |
  |:-----------|---------:|---------:|
  |Always-taker| 1        | 1        |
  |Never-taker | 0        | 0        |
  |Complier    | 0        | 1        |
  |Defier      | 1        | 0        |
  

We consider a population of size $N$ and we define potential outcome $Y$ (in this case crop yield) as a linear function of the form $Y_{i,type} = \alpha_{type} + \beta_{type} * X_i + \delta_{type} * Z_i + u_y$, where $u_y$ is a normally distributed individual-level shock. We consider the treatment to have heterogeneous effects among different complier types.

- **I**nquiry: Firstly, we define the first-stage effect of $Z$ on $X$ as $E[X(Z=1) - X(Z=0)]$.
Our second estimand of interest is the average effect of fertilizer use (our endogenous treatment, $X$), on crop productivity: $ATE = E[Y(X = 1) - Y(X = 0)]$. Thirdly, we are interested in the average treatment effect among compliers (farmers who use fertilizers when awarded the vouchers but don't if otherwise): $LATE = E[Y(X = 1) - Y(X = 0) | type_i = complier]$.

- **D**ata strategy: We collect survey data on a representative sample of 400 farmers and randomly assign  fertilizer vouchers with a probability of 0.5.

- **A**nswer strategy: We estimate the first-stage effect by calculating the difference-in-means estimator of the function $X ~ Z$. For an estimation of the ATE and LATE, we first estimate the effect of endogenous treatment $X$ on $Y$, and second we use a two-stage least squares (2SLS) estimation.



```{r, include = FALSE}
N  <-  100
type_probs  <-  rep(1/4, 4)
assignment_probs  <-  c(0.5, 0.5, 0.5, 0.5)
outcome_sd  <-  1
a  <-  c(1, 0, 0, 0)
b  <-  c(0, 0, 0, 0)
d  <-  c(0, 0, 0, 0)

population <- declare_population(
  N = N, 
  type = sample(1:4, N, replace = TRUE, prob = type_probs), 
  type_label = c("Always", "Never", "Complier", "Defier")[type], 
  u_Z = runif(N), 
  u_Y = rnorm(N) * outcome_sd, Z = (u_Z < assignment_probs[type]), 
  X = (type == 1) + (type == 3) * Z + (type == 4) * (1 - Z))

potential_outcomes <- declare_potential_outcomes(Y ~ a[type] + 
    b[type] * X + d[type] * Z + u_Y, assignment_variables = "X")

reveal <- declare_reveal(outcome_variables = Y, assignment_variables = "X")

estimand <- declare_estimand(
  first_stage = mean((type == 3) - (type == 4)), 
  ate = mean(Y_X_1 - Y_X_0),
  late = mean(Y_X_1[type == 3] - Y_X_0[type == 3]))

estimator_1 <- declare_estimator(X ~ Z, estimand = "first_stage", 
    label = "d-i-m")

estimator_2 <- declare_estimator(Y ~ X, estimand = c("ate", 
    "late"), model = lm_robust, label = "lm_robust")

estimator_3 <- declare_estimator(Y ~ X | Z, estimand = c("ate", 
    "late"), model = iv_robust, label = "iv_robust")

binary_iv_design <- population + potential_outcomes + reveal + 
    estimand + estimator_1 + estimator_2 + estimator_3
```


```{r,eval = TRUE, code = get_design_code(binary_iv_designer(N = 300))}

```

## Takeaways

We now diagnose the design:

```{r}
diagnosis <- diagnose_design(regression_discontinuity_design)
# violate monotonicity -- imbens estimator
## by having defiers in the sample
# violate exclusion restriction
## d_Y != 0
# violate relevance assumption
## b_
```

```{r, echo=FALSE}
kable(reshape_diagnosis(diagnosis)[,-c(1:2)], digits = 2)
```

We highlight three takeaways.

## Using the Binary Instrumental Variable Designer

In R, you can generate an instrumental variable design with binary instrument, treatment, and outcome, using the template function `binary_iv_designer()` in the `DesignLibrary` package by running the following lines, which load the package:

```{r, eval=FALSE}
library(DesignLibrary)
```

We can then create specific designs by defining values for each argument. For example, we create a design called `my_binary_iv_design` with `N` set to 300, with equal probably of compliance types ${always-taker, never-taker, complier}$, that violates the exclusion restriction by running the lines below.

```{r, eval=FALSE}
my_binary_iv_design <- binary_iv_designer(N = 300,
                                          type_probs = c(1/3, 1/3, 1/3, 0),
                                          d = .2)
```

You can see more details on the `binary_iv_designer()` function and its arguments by running the following line of code:

```{r, eval=FALSE}
??binary_iv_designer
```

## Further Reading