---
title: "Binary Instrumental Variable"
output: rmarkdown::html_vignette
bibliography: bib.bib
nocite: |
  @imbens2014instrumental
vignette: >
  %\VignetteIndexEntry{Binary Instrumental Variable}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r MIDA, echo = FALSE,include = FALSE}
library(DesignLibrary)
library(knitr)
```

Instrumental variables methods are often used in experimental or observational settings where we *cannot* credibly assume the treatment of interest is as-if randomly assigned, but we can assume the treatment assignment is influenced by a third variable that is unrelated to the outcome of interest (except through the treatment of interest).

Take two examples of causal relationships researchers might be interested in observing: 

* the effect of distributive benefits on voter turnout and 
* the effect of fertilizer use on farmers' crop yield

In both cases, the treatments of interest may be confounded with the outcomes of interest. For instance politicians might disburse funds to areas with higher turnouts; farmers in places with higher crop yield might have more resources to use fertilizers in the first place. This confounding makes it difficult to learn about the effect of the treatment on the outcome. However, instrumental variables can be a useful approach in these contexts.

Strong instrumental variables satisfy four key assumptions:

* *Relevance*: The instrument $Z$ has a causal effect on the treatment $X$.
* *Exclusion restriction*: The instrument $Z$ affects the outcome $Y$ only through the treatment $X$.
* *Exchangeability* (or *independence*): The instrument $Z$ is as good as randomly assigned (i.e., there is no confounding for the effect of $Z$ on $Y$).
* *Monotonicity*: For all units $i$, $X_i(z_1) \geqslant X_i(x_2)$ when $z_1 \geqslant z_2$ (i.e., there are no units that always defy their assignment).

A weather shock might be an example of an instrument that could be used for studying the effects of distributive benefits on voting. The shock might induce the disbursement of relief aid by the government but not have any other effects on voter turnout. 

A campaign that distributes vouchers for fertilizers might provide  an instrument to understand the effects of fertilizer use on production.

The `binary_iv_designer()` function allows researchers to declare a design of a single instrument $Z$ to estimate the effect of an endogenous treatment $X$ on an outcome $Y$, all of which are binary variables. Below we declare a design using the fertilizer example.

## Design Declaration

* **M**odel: 
    
    We assume our sample has three out of four possible compliance types in a sample of $N$ farmers: always-takers, never-takers, and compliers. In order for the monotonicy assumption to hold, we assume there are no defiers in our sample (no farmers who will adopt fertilizer use if not given the voucher, and who will not adopt it if given the voucher). Below is how we define $X(Z)$ with $Z \in {0,1}$ for each type:
  
  | Type       | $X_i(0)$ | $X_i(1)$ |
  |:-----------|---------:|---------:|
  |Always-taker| 1        | 1        |
  |Never-taker | 0        | 0        |
  |Complier    | 0        | 1        |
  |Defier      | 1        | 0        |
  

    We consider a population of size $N$ and we define potential outcome $Y$ (in this case crop yield) as a linear function of the form $Y_{i,type} = \alpha_{type} + \beta_{type} * X_i + \delta_{type} * Z_i + u_y$, where $u_y$ is a normally distributed individual-level shock. We consider the treatment to have heterogeneous effects among different complier types.

* **I**nquiry:

    Firstly, we define the first-stage effect of $Z$ on $X$ as $E[X(Z=1) - X(Z=0)]$.

    Our second estimand of interest is the average effect of fertilizer use (our endogenous treatment, $X$), on crop productivity: $ATE = E[Y(X = 1) - Y(X = 0)]$.

    Thirdly, we are interested in the average treatment effect among compliers (farmers who use fertilizers when awarded the vouchers but who will not use it if not given voucher): $LATE = E[Y(X = 1) - Y(X = 0) | type_i = complier]$. 
  
    Fourth, when monotonicity does not hold, but independence and exclusion restriction do, we define the estimand as a weighted average of treatment effects for compliers and defiers: $LATE_{het} = \frac{Pr(type = c)}{Pr(type = c) - Pr(type = d)}*E[Y_i(1)-Y_i(0)| type = c] - \frac{Pr(type = d)}{Pr(type = c) - Pr(type = d)}*E[Y_i(1)-Y_i(0)| type = d]$, where $c$ and $d$ are compliers and defiers, respectively [see @imbens2014instrumental: 34].
    
    Last we define the "intent to treat" estimand which gives up on assessing the effect of $X$ on $Y$ and instead seeks only to look at the effect of $Z$ on $Y$. 

* **D**ata strategy: 
    
    We collect survey data on a representative sample of 400 farmers and randomly assign  fertilizer vouchers with a probability of 0.5.

* **A**nswer strategy: 

    We estimate the first-stage effect by calculating the effect of $Z$ on $X$ using differences-in-means. For an estimation of the $ATE$, $LATE$, and $LATE_{het}$ we estimate the effect of endogenous treatment $X$ on $Y$ and use a two-stage least squares (2SLS) estimation.
    For the ITT we  calculate the effect of $Z$ on $Y$ using differences-in-means.
    
```{r,eval = TRUE, code = get_design_code(binary_iv_designer(type_probs = c(0,0,1,0), b_Y = .5))}

```

## Takeaways

We now diagnose the design above and compare our estimates with those of designs that violate the first three assumptions one by one.

```{r}
# Violate relevance of instrument for treatment (no first-stage effects)
iv_nonrelevant <- binary_iv_designer(N = 1000, assignment_probs = c(.2, .3, .7, .5), b_Y = .5)

# Violate relevance of instrument for treatment (no first-stage effects)
iv_nonrandom   <- binary_iv_designer(type_probs = c(.5,.5, 0, 0), b_Y = .5)

# Violate exclusion restriction
iv_nonexcl     <- binary_iv_designer(d_Y = .1)
```

We also compare estimates across designs in which we assume violation of the monotonicity assumption with homogeneous and heterogeneous treatment effects across complier types.

```{r, warning=FALSE}
# Violates monotonicity with homogeneous treatment effects
iv_defiers <- binary_iv_designer(type_probs = c(0,0,.8,.2))

# Violates monotonicity with heterogeneous treatment effects
iv_het     <- binary_iv_designer(type_probs = c(0,0,.8,.2), 
                                 b = c(0.5, 0.5, 0.5, 0))
diagnoses <- diagnose_designs(binary_iv_design, iv_nonrelevant, iv_nonrandom, 
                              iv_nonexcl, iv_defiers, iv_het)
```

```{r, echo=FALSE}
diagnoses_table <- reshape_diagnosis(diagnoses)
```

We highlight a few takeaways. Firstly, our estimates are unbiased when all assumption hold. We show that violating any of the first three assumptions yields biased estimates.

```{r, echo=FALSE}
kable(diagnoses_table[
  diagnoses_table$`Estimand Label` %in% c("late", "ate", "itt") &
    diagnoses_table$`Design Label` %in% c("binary_iv_design","iv_nonrelevant", 
                                          "iv_nonrandom", "iv_nonexcl"),
  c(1:3, 6, 8,14)], digits = 2)
```

In the absence of the monotonicity assumption, our IV estimates are less biased for the LATE than the ATE estimand in the presence of heterogeneous treatment effects. Moreover, in these cases, the IV is best at estimating the weighted average of treatment effects for compliers and defiers ($LATE_{het}$). The difference in means estimate for the ITT estimand always performs well.

```{r, echo=FALSE}
kable(diagnoses_table[diagnoses_table$`Estimand Label` %in% c("ate", "late", "late_het") &
                        diagnoses_table$`Design Label` %in% c("iv_defiers", "iv_het") &
                        diagnoses_table$Bias!= "NA",c(1:3, 6, 8,14)], digits = 2)
```


## References